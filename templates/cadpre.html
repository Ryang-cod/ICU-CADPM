<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CAD Risk Prediction System</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{{ url_for('static', filename='layui/css/layui.css') }}" rel="stylesheet">
  
  <style>
  .layui-table th,.layui-table td{
      text-align:center;
  }
  .file-placeholder {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
    pointer-events: none; /* 让文本不可点击 */
}
input[type="file"] {
    opacity: 0;  /* 隐藏原生 file input */
    width: 150px; /* 让输入框宽度适配 */
}

.custom-text {
    font-size: 20px; /* 设置文字大小 */
    font-weight: bold; /* 加粗文字 */
    color: white; /* 文字颜色 */
    text-align: center; /* 居中文本 */
    margin-top: 20px; /* 设置上边距 */
}
  </style>
  
</head>
<body>
<div class="layui-layout layui-layout-admin">
  <div class="layui-header">
    <div class="layui-logo layui-hide-xs layui-bg-black">ICU-CADPM</div>
    
<div class="layui-container">
    <p class="custom-text">This is a prognostic outcome prediction system for patients with mild coronary artery disease</p>
</div>

    
    
  </div>
  
  <div class="layui-side layui-bg-black">
    <div class="layui-side-scroll">
      <!-- 左侧导航区域 -->
      <ul class="layui-nav layui-nav-tree" lay-filter="test">
        <li class="layui-nav-item layui-nav-itemed">
          <a href="javascript:;">Single-patientss</a>
        </li>
        <li class="layui-nav-item"><a href="javascript:;">Multiple-patients</a> </li>
        <li class="layui-nav-item"><a href="javascript:;">Data feedback</a></li>

      </ul>
    </div>
  </div>
  
  <div id="single-patient" class="layui-body">
      <div style="padding: 15px;">
      <blockquote class="layui-elem-quote layui-text">
        Please enter the characteristic information of individual patients in sequence, then click the prediction button to obtain the mortality risk result
      </blockquote>

    <!-- 单个患者内容 -->
<form class="layui-form layui-row layui-col-space16" action="/submit_data" method="POST">
      <div class="layui-col-sm3">
        <input type="text" name="A" placeholder="GCS score" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <div class="layui-input-wrap">
          <input type="text" name="B" placeholder="CKD_stage" lay-affix="clear" class="layui-input" lay-verify="required">
        </div>
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="C" placeholder="Height(In)" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="D" placeholder="Age" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="E" placeholder="Platelet Count(K/uL)" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="F" placeholder="Bun(mg/dL)" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="G" placeholder="Hemoglobin(g/dL)" class="layui-input" lay-verify="required">
      </div>      
      <div class="layui-col-sm3">
        <input type="text" name="H" placeholder="Fibrinogen,Functional(mg/dL)" class="layui-input" lay-verify="required">
      </div>      
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="I" lay-verify="required">
              <option value="">Gender</option>
              <option value="0">Male</option>
              <option value="1">Female</option>
            </select>
          </div>
        </div>
      </div>      
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="J" lay-verify="required">
              <option value="">Hyperlipidemia</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>           
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="K" lay-verify="required">
              <option value="">Obesity</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>         
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="L" lay-verify="required">
              <option value="">Chronic_kidney_diease</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>         
      <div class="layui-col-md4">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="M" lay-verify="required">
              <option value="">Beta_blocker_used</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>         
      <div class="layui-col-md4">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="N" lay-verify="required">
              <option value="">Warfarin_used</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>         
      <div class="layui-col-md4">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="O" lay-verify="required">
              <option value="">NOAC_used</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>          
  <div class="layui-btn-container layui-col-xs12">
    <button class="layui-btn" lay-submit lay-filter="demo-search">Prediction</button>
    <button type="reset" class="layui-btn layui-btn-primary">Reset</button>
  </div>
</form>
</div>
  </div>
  
  <div id="multiple-patients" class="layui-body" style="display:none;">
    <!-- 多个患者内容 -->
    
    <div style="padding: 15px;">
    <blockquote class="layui-elem-quote layui-text">
        Please upload a formatted file (only CSV/XLSX files are allowed) for predicting the prognosis outcomes of multiple patients, and the final results will be presented in a formatted table. 
        <br>You can click the template download button to obtain the template file.
    </blockquote>
    
    
    
<form class="layui-form layui-row layui-col-space16" action="/upload_file" method="POST" enctype="multipart/form-data">
<div class="layui-col-sm3">
    <label for="file-upload" class="layui-btn layui-btn-primary">Choose File(csv/xlsx)</label>
    <input type="file" name="file" accept=".csv, .xlsx" id="file-upload" hidden>
    <span id="file-name">No file selected</span>
</div>
    <div class="layui-col-sm6">
        <button type="submit" class="layui-btn">Upload and Predict</button>
        <button type="reset" class="layui-btn layui-btn-primary">Delete</button>
<button type="button" class="layui-btn layui-btn-primary" id="download-template">
    <i class="layui-icon layui-icon-download-circle"></i> Template Download
</button>
        
    </div>
</form>



    <table border="1" class="layui-table layui-table-striped" id="patients-table" lay-filter="patientsTable"></table>



    </div>
    <!-- Add form or content specific to "multiple patients" -->
  </div>

  <div id="data-feedback" class="layui-body" style="display:none;">
    <!-- 数据反馈内容 -->
    <div style="padding: 15px;">
    <blockquote class="layui-elem-quote layui-text">
        If the prediction of this application is incorrect, you can provide the correct result to my email.
        <br> Or  you are willing to provide us with new patient data.
    </blockquote>
    
    <!-- 单个患者内容 -->
<form class="layui-form layui-row layui-col-space16">
      <div class="layui-col-sm3">
        <input type="text" name="A" placeholder="GCS score" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <div class="layui-input-wrap">
          <input type="text" name="B" placeholder="CKD_stage" lay-affix="clear" class="layui-input" lay-verify="required">
        </div>
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="C" placeholder="Height(In)" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="D" placeholder="Age" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="E" placeholder="Platelet Count(mg/dL)" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="F" placeholder="Bun(mg/dL)" class="layui-input" lay-verify="required">
      </div>
      <div class="layui-col-sm3">
        <input type="text" name="G" placeholder="Hemoglobin(g/dL)" class="layui-input" lay-verify="required">
      </div>      
      <div class="layui-col-sm3">
        <input type="text" name="H" placeholder="Fibrinogen,Functional(mg/dL)" class="layui-input" lay-verify="required">
      </div>      
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="I" lay-verify="required">
              <option value="">Gender</option>
              <option value="0">Male</option>
              <option value="1">Female</option>
            </select>
          </div>
        </div>
      </div>      
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="J" lay-verify="required">
              <option value="">Hyperlipidemia</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>           
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="K" lay-verify="required">
              <option value="">Obesity</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>         
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="L" lay-verify="required">
              <option value="">Chronic_kidney_diease</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>         
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="M" lay-verify="required">
              <option value="">Beta_blocker_used</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>         
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="N" lay-verify="required">
              <option value="">Warfarin_used</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div>         
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="O" lay-verify="required">
              <option value="">NOAC_used</option>
              <option value="1">YES</option>
              <option value="0">NO</option>
            </select>
          </div>
        </div>
      </div> 
      <div class="layui-col-md3">
        <div class="layui-form-item" style="margin-bottom: 0;">

          <div class="layui-input-block">
            <select name="O" lay-verify="required">
              <option value="">Outcome</option>
              <option value="1">Survival</option>
              <option value="0">Non-survival</option>
            </select>
          </div>
        </div>
      </div>             
  <div class="layui-btn-container layui-col-xs12">
    <button class="layui-btn" type="button" onclick="showFeedbackMsg()">Feedback</button>
    <button type="reset" class="layui-btn layui-btn-primary">Reset</button>
  </div>
</form>
</div>
  </div>

  <div id="contact-us" class="layui-body" style="display:none;">
    <!-- 联系我们内容 -->
    <div style="padding: 15px;">
    <blockquote class="layui-elem-quote layui-text">
        Please enter the patient's characteristic information in sequence, and click the prediction button to obtain the risk of death
    </blockquote>
    
    <p>联系我们内容区</p>
    
    </div>
    <!-- Add form or content specific to "contact us" -->
  </div>

  <div class="layui-footer">
    <!-- 底部固定区域 -->
    This system provides model prediction results, please carefully identify them
  </div>
</div>

<script src="{{ url_for('static', filename='layui/layui.js') }}"></script>
<script>
layui.use(['element', 'layer', 'util'], function(){
  var element = layui.element;
  var layer = layui.layer;
  var util = layui.util;
  var $ = layui.$;

  // 监听侧边栏菜单点击事件
  $('.layui-nav-item').on('click', function(){
    var index = $(this).index();
    $('#single-patient, #multiple-patients, #data-feedback, #contact-us').hide();
    if (index === 0) {
      $('#single-patient').show();
    } else if (index === 1) {
      $('#multiple-patients').show();
    } else if (index === 2) {
      $('#data-feedback').show();
    } else if (index === 3) {
      $('#contact-us').show();
    }
  });

    window.showFeedbackMsg = function() {
        layer.msg('Thank you very much for your feedback!<br>We have received your feedback and will continue to optimize our prediction system based on it.', {icon: 1, time: 2000}); // 2秒后自动关闭
    };
//多患者
layui.use(['table'], function(){
    var table = layui.table;

    var mdata = {{ mdata|default([])|tojson }};  // 从 Flask 渲染的数据

    // 渲染表格
    table.render({
        elem: '#patients-table',
        data: mdata,
        page: true,  // 启用 Layui 内置分页
        limit: 10,   // 每页显示 10 条数据
        cols: [[
        { field: 'id', title: 'ID', width: 80, sort: true },
        { field: 'gcs', title: 'GCS Score' },
        { field: 'CKD_Stage', title: 'CKD Stage' },
        { field: 'height', title: 'Height' },
        { field: 'anchor_age', title: 'Age' },
        { field: 'Platelet Count (K/uL)', title: 'Platelet Count' },
        { field: 'Bun', title: 'Bun' },
        { field: 'Hemoglobin (g/dL)', title: 'Hemoglobin' },
        { field: 'Fibrinogen, Functional', title: 'Fibrinogen' },
        { field: 'gender', title: 'Gender' },
        { field: 'hyperlipidemia', title: 'Hyperlipidemia' },
        { field: 'obesity', title: 'Obesity' },
        { field: 'chronic_kidney_disease', title: 'Chronic Kidney Disease' },
        { field: 'Beta_blocker_used', title: 'Beta Blocker Used' },
        { field: 'warfarin_used', title: 'Warfarin Used' },
        { field: 'NOAC_used', title: 'NOAC Used' },
        { field: 'Prediction', title: 'Prediction', width: 120, sort: true }
        ]]
    });
});


//下载模板文件
document.getElementById('download-template').addEventListener('click', function() {
    window.location.href = '/download_template';
});
document.getElementById("file-upload").addEventListener("change", function() {
    var fileName = this.files.length > 0 ? this.files[0].name : "No file selected";
    document.getElementById("file-name").textContent = fileName;
});



  // 表单提交事件
  layui.form.on('submit(demo-search)', function(data){
    var formData = data.field; // 获取表单数据
    
    // 获取死亡风险预测结果
    var predictionResult = predictRisk(formData);

    // 构造显示的内容
    var resultHtml = "<strong>用户填写的字段：</strong><br>";
    for (var key in formData) {
      if (formData.hasOwnProperty(key)) {
        resultHtml += key + ": " + formData[key] + "<br>";
      }
    }

    resultHtml += "<br><strong>死亡风险预测结果:</strong> " + predictionResult;

    // 显示用户填写的字段和值以及预测结果
    layer.alert(resultHtml, {
      title: '预测结果'
    });

    // 阻止表单默认提交
    return false;
  });

layui.use(['layer'], function(){
  var layer = layui.layer;
  var prediction = "{{ prediction }}";  // 获取后端传递的预测结果
  
var gcs = "{{ gcs }}";
var ckd_stage = "{{ ckd_stage }}";
var height = "{{ height }}";
var age = "{{ age }}";
var platelet_count = "{{ platelet_count }}";
var bun = "{{ bun }}";
var hemoglobin = "{{ hemoglobin }}";
var fibrinogen = "{{ fibrinogen }}";

// 分类变量处理
var gender = ("{{ gender }}" === "0") ? "Male" : "Female"; // 0 -> Male, 1 -> Female
var hyperlipidemia = ("{{ hyperlipidemia }}" === "1") ? "YES" : "NO"; // 1 -> YES, 0 -> NO
var obesity = ("{{ obesity }}" === "1") ? "YES" : "NO"; // 1 -> YES, 0 -> NO
var chronic_kidney_disease = ("{{ chronic_kidney_disease }}" === "1") ? "YES" : "NO"; // 1 -> YES, 0 -> NO
var beta_blocker_used = ("{{ beta_blocker_used }}" === "1") ? "YES" : "NO"; // 1 -> YES, 0 -> NO
var warfarin_used = ("{{ warfarin_used }}" === "1") ? "YES" : "NO"; // 1 -> YES, 0 -> NO
var noac_used = ("{{ noac_used }}" === "1") ? "YES" : "NO"; // 1 -> YES, 0 -> NO


// 将所有变量存入数组
var variables = [
  { name: 'GCS', value: gcs },
  { name: 'CKD_stage', value: ckd_stage },
  { name: 'Height', value: height },
  { name: 'Age', value: age },
  { name: 'Platelet_Count', value: platelet_count },
  { name: 'Bun', value: bun },
  { name: 'Hemoglobin', value: hemoglobin },
  { name: 'Fibrinogen', value: fibrinogen },
  { name: 'Gender', value: gender },
  { name: 'Hyperlipidemia', value: hyperlipidemia },
  { name: 'Obesity', value: obesity },
  { name: 'Chronic_Kidney_Disease', value: chronic_kidney_disease },
  { name: 'Beta_blocker_used', value: beta_blocker_used },
  { name: 'Warfarin_used', value: warfarin_used },
  { name: 'NOAC_used', value: noac_used }
];

// 遍历数组并打印变量
var output = "Patient characteristics："+"<br>";
for (var i = 0; i < variables.length; i++) {
  output += variables[i].name + ": " + variables[i].value + "<br>";
}

// 假设 prediction 已经在其他地方赋值
if (prediction) {
  // 弹出显示预测结果
  layer.alert(output + "<br>" + 'Risk prediction of death: ' + prediction , {
    title: 'Predictive Information',
    icon: 1  // 设置为绿色对话框图标
  });
}
});


});
</script>



</body>
</html>
